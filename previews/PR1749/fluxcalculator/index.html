<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>FluxCalculator · ClimaCoupler.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="ClimaCoupler.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">ClimaCoupler.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Examples</span><ul><li><input class="collapse-toggle" id="menuitem-2-1" type="checkbox"/><label class="tocitem" for="menuitem-2-1"><span class="docs-label">Sea Breeze</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/sea_breeze/atmos_rhs/">Atmospheric Model</a></li><li><a class="tocitem" href="../generated/sea_breeze/land_rhs/">Land Model</a></li><li><a class="tocitem" href="../generated/sea_breeze/ocean_rhs/">Ocean Model</a></li><li><a class="tocitem" href="../generated/sea_breeze/run/">Coupled Sea Breeze</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-2" type="checkbox"/><label class="tocitem" for="menuitem-2-2"><span class="docs-label">AMIP</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/amip/run_amip/">AMIP Driver</a></li></ul></li></ul></li><li><span class="tocitem">Coupler Interface</span><ul><li><a class="tocitem" href="../input/">Input</a></li><li><a class="tocitem" href="../checkpointer/">Checkpointer</a></li><li><a class="tocitem" href="../conservation/">Conservation Checks</a></li><li><a class="tocitem" href="../fieldexchanger/">FieldExchanger</a></li><li class="is-active"><a class="tocitem" href>FluxCalculator</a><ul class="internal"><li><a class="tocitem" href="#How-are-fluxes-computed?"><span>How are fluxes computed?</span></a></li><li><a class="tocitem" href="#FluxCalculator-API"><span>FluxCalculator API</span></a></li></ul></li><li><a class="tocitem" href="../interfacer/">Interfacer</a></li><li><a class="tocitem" href="../models/">Models</a></li><li><a class="tocitem" href="../simcoordinator/">SimCoordinator</a></li><li><a class="tocitem" href="../timemanager/">TimeManager</a></li><li><a class="tocitem" href="../utilities/">Utilities</a></li><li><a class="tocitem" href="../simoutput/">SimOutput</a></li><li><a class="tocitem" href="../plotting/">Plotting</a></li><li><a class="tocitem" href="../calibrationtools/">CalibrationTools</a></li></ul></li><li><span class="tocitem">Performance</span><ul><li><a class="tocitem" href="../performance/">Performance Analysis Tools</a></li></ul></li><li><span class="tocitem">Model Output</span><ul><li><a class="tocitem" href="../diagnostics/">Diagnostics</a></li><li><a class="tocitem" href="../leaderboard/">Leaderboard</a></li></ul></li><li><a class="tocitem" href="../contributing/">Contributing</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Coupler Interface</a></li><li class="is-active"><a href>FluxCalculator</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>FluxCalculator</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/ClimaCoupler.jl/blob/main/docs/src/fluxcalculator.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="FluxCalculator"><a class="docs-heading-anchor" href="#FluxCalculator">FluxCalculator</a><a id="FluxCalculator-1"></a><a class="docs-heading-anchor-permalink" href="#FluxCalculator" title="Permalink"></a></h1><p>This module contains the infrastructure to compute turbulent fluxes.</p><h2 id="How-are-fluxes-computed?"><a class="docs-heading-anchor" href="#How-are-fluxes-computed?">How are fluxes computed?</a><a id="How-are-fluxes-computed?-1"></a><a class="docs-heading-anchor-permalink" href="#How-are-fluxes-computed?" title="Permalink"></a></h2><p>The key function that computes surface fluxes is <a href="#ClimaCoupler.FluxCalculator.turbulent_fluxes!"><code>FluxCalculator.turbulent_fluxes!</code></a>. This function computes turbulent fluxes and ancillary quantities, such as the Obukhov length, using <a href="https://github.com/CliMA/SurfaceFluxes.jl">SurfaceFluxes.jl</a>. Generally, this function is called at the end of each coupling step.</p><p>All the quantities computed in <code>turbulent_fluxes!</code> are calculated separately for each surface model using the <a href="#ClimaCoupler.FluxCalculator.compute_surface_fluxes!"><code>FluxCalculator.compute_surface_fluxes!</code></a> function. This function can be extended by component models if they need specific type of flux calculation, and a default is provided for models that can use the standard flux calculation.</p><p>The default method of <a href="#ClimaCoupler.FluxCalculator.compute_surface_fluxes!"><code>FluxCalculator.compute_surface_fluxes!</code></a>, in turn, calls <a href="#ClimaCoupler.FluxCalculator.get_surface_fluxes"><code>FluxCalculator.get_surface_fluxes</code></a>. This function uses a thermal state obtained by using the model surface temperature, extrapolates atmospheric density adiabatically to the surface, and with the surface humidity (if available, if not, assuming a saturation specific humidity for liquid phase). <code>compute_surface_fluxes!</code> also updates the component internal fluxes fields via <a href="#ClimaCoupler.FluxCalculator.update_turbulent_fluxes!"><code>FluxCalculator.update_turbulent_fluxes!</code></a>, and adds the area-weighted contribution from this component model to the <code>CoupledSimulation</code> fluxes fields.</p><p>Any extension of <code>FluxCalculator.compute_surface_fluxes!</code> for a particular surface model is also expected to update both the component models&#39; internal fluxes and the CoupledSimulation object&#39;s fluxes fields.</p><p><a href="#ClimaCoupler.FluxCalculator.compute_surface_fluxes!"><code>FluxCalculator.compute_surface_fluxes!</code></a> sets:</p><ul><li>the flux of momenta, <code>F_turb_ρτxz</code>, <code>F_turb_ρτyz</code>;</li><li>the flux of energy due to latent heat, <code>F_lh</code>;</li><li>the flux of energy due to sensible heat, <code>F_sh</code>;</li><li>the flux of moisture, <code>F_turb_moisture</code>;</li><li>the Obukhov length, <code>L_MO</code>;</li><li>the buoyancy flux, <code>buoyancy_flux</code>;</li><li>the roughness lengths for momentum and buoyancy, <code>z0m</code> and <code>z0b</code>;</li><li>the frictional velocity <code>ustar</code>.</li></ul><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p><a href="#ClimaCoupler.FluxCalculator.compute_surface_fluxes!"><code>FluxCalculator.compute_surface_fluxes!</code></a> always returns the area weighted sum, even if this is not necessarily the most meaningful operation for a given quantity (e.g., for the Obukhov length). This can be improved in the future, if you know how, please open an issue.</p></div></div><p>Note also that <a href="#ClimaCoupler.FluxCalculator.turbulent_fluxes!"><code>FluxCalculator.turbulent_fluxes!</code></a> only computes turbulent fluxes, not radiative fluxes. Currently, these are computed within the atmospheric model.</p><h2 id="FluxCalculator-API"><a class="docs-heading-anchor" href="#FluxCalculator-API">FluxCalculator API</a><a id="FluxCalculator-API-1"></a><a class="docs-heading-anchor-permalink" href="#FluxCalculator-API" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="ClimaCoupler.FluxCalculator.turbulent_fluxes!" href="#ClimaCoupler.FluxCalculator.turbulent_fluxes!"><code>ClimaCoupler.FluxCalculator.turbulent_fluxes!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">turbulent_fluxes!(cs::CoupledSimulation)
turbulent_fluxes!(fields, model_sims, thermo_params)</code></pre><p>Compute turbulent fluxes and associated quantities. Store the results in <code>fields</code> as area-weighted sums.</p><p>This function uses <code>SurfaceFluxes.jl</code> under the hood.</p><p>Args:</p><ul><li><code>csf</code>: [Field of NamedTuple] containing coupler fields.</li><li><code>model_sims</code>: [NamedTuple] containing <code>AbstractComponentSimulation</code>s.</li><li><code>thermo_params</code>: [TD.Parameters.ThermodynamicsParameters] the thermodynamic parameters.</li></ul><p>TODO:</p><ul><li>generalize interface for regridding and take land state out of atmos&#39;s integrator.p</li><li>add flux accumulation</li><li>add flux bounds</li></ul><p>(NB: Radiation surface fluxes are calculated by the atmosphere.)</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaCoupler.jl/blob/d80b77ce635fc1fa6c4d92cb2991119ecea47627/src/FluxCalculator.jl#L27-L47">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ClimaCoupler.FluxCalculator.compute_surface_fluxes!" href="#ClimaCoupler.FluxCalculator.compute_surface_fluxes!"><code>ClimaCoupler.FluxCalculator.compute_surface_fluxes!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">compute_surface_fluxes!(csf, sim::BucketSimulation, atmos_sim, thermo_params)</code></pre><p>This function computes surface fluxes between the bucket simulation and the atmosphere.</p><p>Update the input coupler surface fields <code>csf</code> in-place with the computed fluxes for this model. These are then summed using area-weighting across all surface models to get the total fluxes. Fluxes where the area fraction is zero are set to zero.</p><p>Currently, this calculation is done on the land surface space, and the computed fluxes are remapped onto the coupler boundary space as the coupler fields are updated. In the future, we may compute fluxes in the bucket model&#39;s internal <code>step!</code> function.</p><p><strong>Arguments</strong></p><ul><li><code>csf</code>: [CC.Fields.Field] containing a NamedTuple of turbulent flux fields: <code>F_turb_ρτxz</code>, <code>F_turb_ρτyz</code>, <code>F_lh</code>, <code>F_sh</code>, <code>F_turb_moisture</code>.</li><li><code>sim</code>: [BucketSimulation] the bucket simulation to compute fluxes for.</li><li><code>atmos_sim</code>: [Interfacer.AbstractAtmosSimulation] the atmosphere simulation to compute fluxes with.</li><li><code>thermo_params</code>: [ClimaParams.ThermodynamicParameters] the thermodynamic parameters for the simulation.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaCoupler.jl/blob/d80b77ce635fc1fa6c4d92cb2991119ecea47627/ext/climaland/climaland_bucket.jl#L409-L427">source</a></section><section><div><pre><code class="nohighlight hljs">compute_surface_fluxes!(csf, sim::ClimaLandSimulation, atmos_sim, thermo_params)</code></pre><p>This function computes surface fluxes between the integrated land model simulation and the atmosphere.</p><p>Update the input coupler surface fields <code>csf</code> in-place with the computed fluxes for this model. These are then summed using area-weighting across all surface models to get the total fluxes. Fluxes where the area fraction is zero are set to zero.</p><p>The integrated land model requires fluxes to be computed implicitly, so they are computed in the land model&#39;s internal <code>step!</code> function, where they can be solved for at the same time as canopy temperature. As a result, this function does not actually compute the fluxes. However, it does access them from the land cache, combine them to get the total fluxes for the integrated land model, and update the coupler fields in-place.</p><p>Because the integrated land model is composed of multiple sub-components, the fluxes are computed for each sub-component and then combined here to get the total for this model. The land model cache contains the computed fluxes for each sub-component.</p><p><strong>Arguments</strong></p><ul><li><code>csf</code>: [CC.Fields.Field] containing a NamedTuple of turbulent flux fields: <code>F_turb_ρτxz</code>, <code>F_turb_ρτyz</code>, <code>F_lh</code>, <code>F_sh</code>, <code>F_turb_moisture</code>.</li><li><code>sim</code>: [ClimaLandSimulation] the integrated land simulation to compute fluxes for.</li><li><code>atmos_sim</code>: [Interfacer.AbstractAtmosSimulation] the atmosphere simulation to compute fluxes with.</li><li><code>thermo_params</code>: [ClimaParams.ThermodynamicParameters] the thermodynamic parameters for the simulation.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaCoupler.jl/blob/d80b77ce635fc1fa6c4d92cb2991119ecea47627/ext/climaland/climaland_integrated.jl#L581-L606">source</a></section><section><div><pre><code class="nohighlight hljs">compute_surface_fluxes!(csf, sim, atmos_sim, thermo_params)</code></pre><p>This function computes surface fluxes between the input component model simulation and the atmosphere.</p><p>Update the input coupler surface fields <code>csf</code> in-place with the computed fluxes for this model. These are then summed using area-weighting across all surface models to get the total fluxes.</p><p>Since the fluxes are computed between the input model and the atmosphere, this function does nothing if called on an atmosphere model simulation.</p><p>The function for AbstractImplicitFluxSimulation is a placeholder that does nothing. Currently, the only AbstractImplicitFluxSimulation is ClimaLandSimulation, for which compute<em>surface</em>fluxes! is defined in the component model. We can extend this function for other AbstractImplicitFluxSimulation in the future.</p><p><strong>Arguments</strong></p><ul><li><code>csf</code>: [CC.Fields.Field] containing a NamedTuple of turbulent flux fields: <code>F_turb_ρτxz</code>, <code>F_turb_ρτyz</code>, <code>F_lh</code>, <code>F_sh</code>, <code>F_turb_moisture</code>.</li><li><code>sim</code>: [Interfacer.AbstractComponentSimulation] the surface simulation to compute fluxes for.</li><li><code>atmos_sim</code>: [Interfacer.AbstractAtmosSimulation] the atmosphere simulation to compute fluxes with.</li><li><code>thermo_params</code>: [TD.Parameters.ThermodynamicsParameters] the thermodynamic parameters.</li></ul><p>The roughness model is obtained from the simulation via <code>get_field(sim, Val(:roughness_model))</code>. Ocean simulations return <code>:coare3</code>, while land and ice simulations return <code>:constant</code> (the default).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaCoupler.jl/blob/d80b77ce635fc1fa6c4d92cb2991119ecea47627/src/FluxCalculator.jl#L182-L208">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ClimaCoupler.FluxCalculator.get_surface_fluxes" href="#ClimaCoupler.FluxCalculator.get_surface_fluxes"><code>ClimaCoupler.FluxCalculator.get_surface_fluxes</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">get_surface_fluxes(inputs, surface_params::SF.Parameters.SurfaceFluxesParameters)</code></pre><p>Uses SurfaceFluxes.jl to calculate turbulent surface fluxes. It should be atmos model agnostic, and columnwise. Fluxes are computed over the entire surface, even where the relevant surface model is not present.</p><p>When available, it also computes ancillary quantities, such as the Monin-Obukov lengthscale.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaCoupler.jl/blob/d80b77ce635fc1fa6c4d92cb2991119ecea47627/src/FluxCalculator.jl#L78-L85">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ClimaCoupler.FluxCalculator.update_turbulent_fluxes!" href="#ClimaCoupler.FluxCalculator.update_turbulent_fluxes!"><code>ClimaCoupler.FluxCalculator.update_turbulent_fluxes!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">FluxCalculator.update_turbulent_fluxes!(sim::OceananigansSimulation, fields)</code></pre><p>Update the turbulent fluxes in the simulation using the values computed at this time step. These include latent heat flux, sensible heat flux, momentum fluxes, and moisture flux.</p><p>Rather than setting the surface fluxes and overwriting previous values, this function adds only the contributions from the turbulent fluxes. <code>update_sim!</code> sets the surface fluxes due to radiation and precipitation. Additional contributions may be made in <code>ocean_seaice_fluxes!</code>. An exception is the momentum fluxes, which are set directly here since they are not updated in <code>update_sim!</code>.</p><p>A note on sign conventions: SurfaceFluxes and Oceananigans both use the convention that a positive flux is an upward flux. No sign change is needed during the exchange, except for moisture/salinity fluxes: SurfaceFluxes provides moisture moving from atmosphere to ocean as a negative flux at the surface, and Oceananigans represents moisture moving from atmosphere to ocean as a positive salinity flux, so a sign change is needed when we convert from moisture to salinity flux.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaCoupler.jl/blob/d80b77ce635fc1fa6c4d92cb2991119ecea47627/ext/ClimaCouplerCMIPExt/oceananigans.jl#L351-L369">source</a></section><section><div><pre><code class="nohighlight hljs">FluxCalculator.update_turbulent_fluxes!(sim::ClimaSeaIceSimulation, fields)</code></pre><p>Update the turbulent fluxes in the simulation using the values stored in the coupler fields. These include latent heat flux, sensible heat flux, momentum fluxes, and moisture flux.</p><p>The input <code>fields</code> are already area-weighted, so there&#39;s no need to weight them again.</p><p>Note that currently the moisture flux has no effect on the sea ice model, which has constant salinity.</p><p>A note on sign conventions: SurfaceFluxes and ClimaSeaIce both use the convention that a positive flux is an upward flux. No sign change is needed during the exchange, except for moisture/salinity fluxes: SurfaceFluxes provides moisture moving from atmosphere to ocean as a negative flux at the surface, and ClimaSeaIce represents moisture moving from atmosphere to ocean as a positive salinity flux, so a sign change is needed when we convert from moisture to salinity flux.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaCoupler.jl/blob/d80b77ce635fc1fa6c4d92cb2991119ecea47627/ext/ClimaCouplerCMIPExt/clima_seaice.jl#L298-L315">source</a></section><section><div><pre><code class="nohighlight hljs">update_turbulent_fluxes!(sim::Interfacer.AbstractComponentSimulation, fields::NamedTuple)</code></pre><p>Updates the fluxes in the simulation <code>sim</code> with the fluxes in <code>fields</code>.</p><p>For surface models, this should be the fluxes computed between the surface model and the atmosphere. For atmosphere models, this should be the area-weighted sum of fluxes across all surface models.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/CliMA/ClimaCoupler.jl/blob/d80b77ce635fc1fa6c4d92cb2991119ecea47627/src/FluxCalculator.jl#L166-L173">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../fieldexchanger/">« FieldExchanger</a><a class="docs-footer-nextpage" href="../interfacer/">Interfacer »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Saturday 21 February 2026 00:57">Saturday 21 February 2026</span>. Using Julia version 1.11.9.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
