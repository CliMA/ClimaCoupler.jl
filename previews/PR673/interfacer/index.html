<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Interfacer · ClimaCoupler.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="ClimaCoupler.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">ClimaCoupler.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Examples</span><ul><li><input class="collapse-toggle" id="menuitem-2-1" type="checkbox"/><label class="tocitem" for="menuitem-2-1"><span class="docs-label">Sea Breeze</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/sea_breeze/atmos_rhs/">Atmospheric Model</a></li><li><a class="tocitem" href="../generated/sea_breeze/land_rhs/">Land Model</a></li><li><a class="tocitem" href="../generated/sea_breeze/ocean_rhs/">Ocean Model</a></li><li><a class="tocitem" href="../generated/sea_breeze/run/">Coupled Sea Breeze</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-2" type="checkbox"/><label class="tocitem" for="menuitem-2-2"><span class="docs-label">AMIP</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/amip/coupler_driver/">AMIP Driver</a></li></ul></li></ul></li><li><span class="tocitem">Coupler Interface</span><ul><li><a class="tocitem" href="../regridder/">Regridder</a></li><li><a class="tocitem" href="../conservation/">Conservation Checks</a></li><li><a class="tocitem" href="../utilities/">Utilities</a></li><li><a class="tocitem" href="../bcreader/">BCReader</a></li><li><a class="tocitem" href="../testhelper/">TestHelper</a></li><li><a class="tocitem" href="../timemanager/">TimeManager</a></li></ul></li><li><span class="tocitem">Performance</span><ul><li><a class="tocitem" href="../performance/">Performance Analysis Tools</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Interfacer</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Interfacer</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/ClimaCoupler.jl/blob/main/docs/src/interfacer.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Interfacer"><a class="docs-heading-anchor" href="#Interfacer">Interfacer</a><a id="Interfacer-1"></a><a class="docs-heading-anchor-permalink" href="#Interfacer" title="Permalink"></a></h1><p>This module contains functions that define the interface for coupling component models, as well as stub objects that contain prescribed fields. Here we explain each type of component model, and the functions that must be implemented to use a component model with ClimaCoupler.jl</p><h2 id="Coupled-simulation"><a class="docs-heading-anchor" href="#Coupled-simulation">Coupled simulation</a><a id="Coupled-simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Coupled-simulation" title="Permalink"></a></h2><p>A <code>CoupledSimulation</code> stores info for ESM run and contains each of the component model simulations. We currently require that each <code>CoupledSimulation</code> contains four components: <code>atmos_sim</code>, <code>land_sim</code>, <code>ocean_sim</code> and <code>ice_sim</code>. If a simulation surface type is not needed for a given run, it should be initialized with <code>SurfaceStub</code> with a zero <code>area_fracion</code>. The <code>atmos_sim</code> should always be specified.</p><h2 id="Component-simulations"><a class="docs-heading-anchor" href="#Component-simulations">Component simulations</a><a id="Component-simulations-1"></a><a class="docs-heading-anchor-permalink" href="#Component-simulations" title="Permalink"></a></h2><p>Individual component model simulations fall under <code>ComponentModelSimulation</code>, which together combine to make the <code>CoupledSimulation</code>. We have two types of <code>ComponentModelSimulations</code>: <code>AtmosModelSimulation</code> and <code>SurfaceModelSimulation</code>. The two have different requirements, which are detailed below. <code>SurfaceModelSimulation</code> is further divided into <code>SeaIceModelSimulation</code>, <code>LandModelSimulation</code>, and <code>OceanModelSimulation</code>, representing the 3 currently-supported options for surface models.</p><h3 id="ComponentModelSimulation-required-functions"><a class="docs-heading-anchor" href="#ComponentModelSimulation-required-functions">ComponentModelSimulation - required functions</a><a id="ComponentModelSimulation-required-functions-1"></a><a class="docs-heading-anchor-permalink" href="#ComponentModelSimulation-required-functions" title="Permalink"></a></h3><p>A component model simulation should be implemented as a struct that is a concrete subtype of a <code>ComponentModelSimulation</code>. This struct should contain all of the information needed to run that simulation.</p><p>Each <code>ComponentModelSimulation</code> must extend the following functions to be able to use our coupler. For some existing models, these are defined within ClimaCoupler.jl in that model’s <code>init.jl</code> file, but it is preferable for these to be defined in a model’s own repository. Note that the dispatch <code>::ComponentModelSimulation</code> in the function definitions given below should be replaced with the particular component model extending these functions.</p><ul><li><code>init</code>: construct and return an instance of the <code>ComponentModelSimulation</code>,</li></ul><p>and perform all initialization. This function should return a simulation that is ready to be stepped in the coupled simulation. The interface for this function varies across component models.</p><ul><li><code>name(::ComponentModelSimulation)</code>: return a string containing the name of</li></ul><p>this <code>ComponentModelSimulation</code>, which is used for printing information about component models and writing to checkpoint files.</p><ul><li><code>step!(::ComponentModelSimulation, t)</code>: A function to update the</li></ul><p>simulation in-place with values calculate for time <code>t</code>. For the models we currently have implemented, this is a simple wrapper around the <code>step!</code> function implemented in SciMLBase.jl.</p><ul><li><code>reinit!(::ComponentModelSimulation)</code>: A function to restart a simulation</li></ul><p>after solving of the simulation has been paused or interrupted. Like <code>step!</code>, this is currently a simple wrapper around the <code>reinit!</code> function of SciMLBase.jl.</p><ul><li><code>get_model_prog_state(::ComponentModelSimulation)</code>: A function that</li></ul><p>returns the state vector of the simulation at its current state. This is used for checkpointing the simulation.</p><h3 id="ComponentModelSimulation-optional-functions"><a class="docs-heading-anchor" href="#ComponentModelSimulation-optional-functions">ComponentModelSimulation - optional functions</a><a id="ComponentModelSimulation-optional-functions-1"></a><a class="docs-heading-anchor-permalink" href="#ComponentModelSimulation-optional-functions" title="Permalink"></a></h3><ul><li><code>update_sim!(::ComponentModelSimulation, csf, turbulent_fluxes)</code>: A</li></ul><p>function to update each of the fields of the component model simulation that are updated by the coupler. ClimaCoupler.jl provides defaults of this function for both <code>AtmosModelSimulation</code> and <code>SurfaceModelSimulation</code> that update each of the fields expected by the coupler. This function can optionally be extended to include additional field updates as desired.</p><h3 id="AtmosModelSimulation-required-functions"><a class="docs-heading-anchor" href="#AtmosModelSimulation-required-functions">AtmosModelSimulation - required functions</a><a id="AtmosModelSimulation-required-functions-1"></a><a class="docs-heading-anchor-permalink" href="#AtmosModelSimulation-required-functions" title="Permalink"></a></h3><p>In addition to the functions required for a general <code>ComponentModelSimulation</code>, an <code>AtmosModelSimulation</code> requires the following functions to retrieve and update its fields.</p><ul><li><code>get_field(::AtmosModelSimulation. ::Val{property})</code>: This getter</li></ul><p>function returns the value of the field property for the simulation in its current state. For an <code>AtmosModelSimulation</code>, it must be extended for the following properties:</p><table><tr><th style="text-align: right">Coupler name</th><th style="text-align: right">Description</th><th style="text-align: right">Units</th></tr><tr><td style="text-align: right"><code>air_density</code></td><td style="text-align: right">air density at the surface of the atmosphere</td><td style="text-align: right">kg m^-3</td></tr><tr><td style="text-align: right"><code>air_temperature</code></td><td style="text-align: right">air temperature at the surface of the atmosphere</td><td style="text-align: right">K</td></tr><tr><td style="text-align: right"><code>energy</code></td><td style="text-align: right">globally integrated energy</td><td style="text-align: right">J</td></tr><tr><td style="text-align: right"><code>height_int</code></td><td style="text-align: right">height at the first internal model level</td><td style="text-align: right">m</td></tr><tr><td style="text-align: right"><code>height_sfc</code></td><td style="text-align: right">height at the surface (only required when using <code>PartitionedStateFluxes</code>)</td><td style="text-align: right">m</td></tr><tr><td style="text-align: right"><code>liquid_precipitation</code></td><td style="text-align: right">liquid precipitation at the surface</td><td style="text-align: right">kg m^-2 s^-1</td></tr><tr><td style="text-align: right"><code>radiative_energy_flux_sfc</code></td><td style="text-align: right">net radiative flux at the surface</td><td style="text-align: right">W m^-2</td></tr><tr><td style="text-align: right"><code>radiative_energy_flux_toa</code></td><td style="text-align: right">net radiative flux at the top of the atmosphere</td><td style="text-align: right">W m^-2</td></tr><tr><td style="text-align: right"><code>snow_precipitation</code></td><td style="text-align: right">snow precipitation at the surface</td><td style="text-align: right">kg m^-2 s^-1</td></tr><tr><td style="text-align: right"><code>turbulent_energy_flux</code></td><td style="text-align: right">aerodynamic turbulent surface fluxes of energy (sensible and latent heat)</td><td style="text-align: right">W m^-2</td></tr><tr><td style="text-align: right"><code>turbulent_moisture_flux</code></td><td style="text-align: right">aerodynamic turbulent surface fluxes of energy (evaporation)</td><td style="text-align: right">kg m^-2 s^-1</td></tr><tr><td style="text-align: right"><code>thermo_state_int</code></td><td style="text-align: right">thermodynamic state at the first internal model level</td><td style="text-align: right"></td></tr><tr><td style="text-align: right"><code>uv_int</code></td><td style="text-align: right">horizontal wind velocity vector at the first internal model level</td><td style="text-align: right">m s^-1</td></tr><tr><td style="text-align: right"><code>water</code></td><td style="text-align: right">globally integrated water</td><td style="text-align: right">kg</td></tr></table><ul><li><code>update_field!(::AtmosModelSimulation. ::Val{property}, field)</code>:</li></ul><p>A function to update the value of property in the component model simulation, using the values in <code>field</code>. This update should be done in place. If this function isn&#39;t extended for a property, that property will remain constant throughout the simulation and a warning will be raised. This function is expected to be extended for the following properties:</p><table><tr><th style="text-align: right">Coupler name</th><th style="text-align: right">Description</th><th style="text-align: right">Units</th></tr><tr><td style="text-align: right"><code>co2</code></td><td style="text-align: right">global mean co2</td><td style="text-align: right">ppm</td></tr><tr><td style="text-align: right"><code>surface_albedo</code></td><td style="text-align: right">bulk surface albedo over the whole surface space</td><td style="text-align: right"></td></tr><tr><td style="text-align: right"><code>surface_temperature</code></td><td style="text-align: right">temperature over the combined surface space</td><td style="text-align: right">K</td></tr><tr><td style="text-align: right"><code>turbulent_fluxes</code></td><td style="text-align: right">turbulent fluxes (note: only required when using <code>PartitionedStateFluxes</code> option - see our <code>FluxCalculator</code> module docs for more information)</td><td style="text-align: right">W m^-2</td></tr></table><h3 id="SurfaceModelSimulation-required-functions"><a class="docs-heading-anchor" href="#SurfaceModelSimulation-required-functions">SurfaceModelSimulation - required functions</a><a id="SurfaceModelSimulation-required-functions-1"></a><a class="docs-heading-anchor-permalink" href="#SurfaceModelSimulation-required-functions" title="Permalink"></a></h3><p>Analogously to the <code>AtmosModelSimulation</code>, a <code>SurfaceModelSimulation</code> requires additional functions to those required for a general <code>ComponentModelSimulation</code>.</p><ul><li><code>get_field(::SurfaceModelSimulation. ::Val{property})</code>: This getter</li></ul><p>function returns the value of the field property for the simulation at the current time. For a <code>SurfaceModelSimulation</code>, it must be extended for the following properties:</p><table><tr><th style="text-align: right">Coupler name</th><th style="text-align: right">Description</th><th style="text-align: right">Units</th></tr><tr><td style="text-align: right"><code>air_density</code></td><td style="text-align: right">surface air density</td><td style="text-align: right">kg m^-3</td></tr><tr><td style="text-align: right"><code>area_fraction</code></td><td style="text-align: right">fraction of the simulation grid surface area this model covers</td><td style="text-align: right"></td></tr><tr><td style="text-align: right"><code>beta</code></td><td style="text-align: right">factor that scales evaporation based on its estimated level of saturation</td><td style="text-align: right"></td></tr><tr><td style="text-align: right"><code>roughness_buoyancy</code></td><td style="text-align: right">aerodynamic roughness length for buoyancy</td><td style="text-align: right">m</td></tr><tr><td style="text-align: right"><code>roughness_momentum</code></td><td style="text-align: right">aerodynamic roughness length for momentum</td><td style="text-align: right">m</td></tr><tr><td style="text-align: right"><code>surface_albedo</code></td><td style="text-align: right">bulk surface albedo</td><td style="text-align: right"></td></tr><tr><td style="text-align: right"><code>surface_humidity</code></td><td style="text-align: right">surface humidity</td><td style="text-align: right">kg kg^-1</td></tr><tr><td style="text-align: right"><code>surface_temperature</code></td><td style="text-align: right">surface temperature</td><td style="text-align: right">K</td></tr></table><ul><li><code>update_field!(::SurfaceModelSimulation. ::Val{property}, field)</code>:</li></ul><p>A function to update the value of property in the component model simulation, using the values in <code>field</code> passed from the coupler This update should be done in place. If this function isn&#39;t extended for a property, that property will remain constant throughout the simulation and a warning will be raised. This function is expected to be extended for the following properties:</p><table><tr><th style="text-align: right">Coupler name</th><th style="text-align: right">Description</th><th style="text-align: right">Units</th></tr><tr><td style="text-align: right"><code>air_density</code></td><td style="text-align: right">surface air density</td><td style="text-align: right">kg m^-3</td></tr><tr><td style="text-align: right"><code>area_fraction</code></td><td style="text-align: right">fraction of the simulation grid surface area this model covers</td><td style="text-align: right"></td></tr><tr><td style="text-align: right"><code>liquid_precipitation</code></td><td style="text-align: right">liquid precipitation at the surface</td><td style="text-align: right">kg m^-2 s^-1</td></tr><tr><td style="text-align: right"><code>radiative_energy_flux_sfc</code></td><td style="text-align: right">net radiative flux at the surface</td><td style="text-align: right">W m^-2</td></tr><tr><td style="text-align: right"><code>snow_precipitation</code></td><td style="text-align: right">snow precipitation at the surface</td><td style="text-align: right">kg m^-2 s^-1</td></tr><tr><td style="text-align: right"><code>turbulent_energy_flux</code></td><td style="text-align: right">aerodynamic turbulent surface fluxes of energy (sensible and latent heat)</td><td style="text-align: right">W m^-2</td></tr><tr><td style="text-align: right"><code>turbulent_moisture_flux</code></td><td style="text-align: right">aerodynamic turbulent surface fluxes of energy (evaporation)</td><td style="text-align: right">kg m^-2 s^-1</td></tr></table><h3 id="SurfaceModelSimulation-optional-functions"><a class="docs-heading-anchor" href="#SurfaceModelSimulation-optional-functions">SurfaceModelSimulation - optional functions</a><a id="SurfaceModelSimulation-optional-functions-1"></a><a class="docs-heading-anchor-permalink" href="#SurfaceModelSimulation-optional-functions" title="Permalink"></a></h3><ul><li><code>update_turbulent_fluxes_point!(::ComponentModelSimulation, fields::NamedTuple, colidx)</code>:</li></ul><p>This function updates the turbulent fluxes of the component model simulation at this point in horizontal space. The values are updated using the energy and moisture turbulent fluxes stored in fields which are calculated by the coupler. Note that this function is only required when using the <code>PartitionedStateFluxes</code> option of ClimaCoupler.jl. See our <code>FluxCalculator</code> module docs for more information.</p><h3 id="Prescribed-surface-conditions-SurfaceStub"><a class="docs-heading-anchor" href="#Prescribed-surface-conditions-SurfaceStub">Prescribed surface conditions - SurfaceStub</a><a id="Prescribed-surface-conditions-SurfaceStub-1"></a><a class="docs-heading-anchor-permalink" href="#Prescribed-surface-conditions-SurfaceStub" title="Permalink"></a></h3><ul><li><code>SurfaceStub</code> is a <code>SurfaceModelSimulation</code>, but it only contains</li></ul><p>required data in <code>&lt;surface_stub&gt;.cache</code>, e.g., for the calculation of surface fluxes through a prescribed surface state. The above adapter functions are already predefined for <code>SurfaceStub</code>, with the cache variables specified as:</p><pre><code class="nohighlight hljs">get_field(sim::SurfaceStub, ::Val{:air_density}) = sim.cache.ρ_sfc
get_field(sim::SurfaceStub, ::Val{:area_fraction}) = sim.cache.area_fraction
get_field(sim::SurfaceStub, ::Val{:beta}) = sim.cache.beta
get_field(sim::SurfaceStub, ::Val{:energy}) = nothing
get_field(sim::SurfaceStub, ::Val{:roughness_buoyancy}) = sim.cache.z0b
get_field(sim::SurfaceStub, ::Val{:roughness_momentum}) = sim.cache.z0m
get_field(sim::SurfaceStub, ::Val{:surface_albedo}) = sim.cache.α
get_field(sim::SurfaceStub, ::Val{:surface_humidity}) = TD.q_vap_saturation_generic.(sim.cache.thermo_params, sim.cache.T_sfc, sim.cache.ρ_sfc, sim.cache.phase)
get_field(sim::SurfaceStub, ::Val{:surface_temperature}) = sim.cache.T_sfc
get_field(sim::SurfaceStub, ::Val{:water}) = nothing</code></pre><p>and with the corresponding <code>update_field!</code> functions</p><pre><code class="nohighlight hljs">function update_field!(sim::SurfaceStub, ::Val{:air_density}, field)
    sim.cache.ρ_sfc .= field
end
function update_field!(sim::SurfaceStub, ::Val{:area_fraction}, field::Fields.Field)
    sim.cache.area_fraction .= field
end
function update_field!(sim::SurfaceStub, ::Val{:surface_temperature}, field::Fields.Field)
    sim.cache.T_sfc .= field
end</code></pre></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Wednesday 6 March 2024 21:50">Wednesday 6 March 2024</span>. Using Julia version 1.10.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
